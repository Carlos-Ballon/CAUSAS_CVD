---
title: "Pilot_results"
format: docx
editor: source
---

## Load packages

```{r}
# Packages
pacman::p_load(
  rio,
  here, 
  janitor,
  tidyverse,
  REDCapR,
  REDCapDM,
  rfextras,
  gtsummary,
  Hmisc,
  anthroplus,
  rspiro,
  childsds,
  pedbp,
  finalfit,
  pwr,
  corrplot,
  rstatix,
  rcompanion,
  flextable,
  officer
)

# Scripts
source(here::here("scripts", "PAQ-C_item_9.R"))
```

# Set gtsummary theme

```{r}
# Set gtsummary theme
gtsummary::theme_gtsummary_journal(journal = "jama")

# Set gtsummary language
gtsummary::theme_gtsummary_language(language = "es")
```

## Import data

```{r}
#| include: false
# Read REDCap data
source(here::here("scripts", "credentials.R"))

# Transformation of raw data into factors (labels)
proyecto_procesado <- rd_transform(proyecto_redcap)

# Extract the data frame
data <- proyecto_procesado$data

# Variable labels
source(here::here("scripts", "labels.R"))

# Check
head(data, 10)
```

## Process data

```{r}
#| include: false
data_clear <- data |>
  mutate(
    # Sexo
    sexo = case_when(
      record_id %in% c(
        "001 - Rihana Fabiola Ajalcriña Tejada",
        "003 - Grace Alcabuino Hermoza",
        "004 - Flavia Ajalcriña Tejada",
        "010 - Yomayra Genesis De la O",
        "013 - Yadira Romero Nacazama",
        "014 - Saskia Zatalaya Bustos",
        "015 - Sofia Perez Canturini",
        "016 - Daniela Palma Cruz",
        "018 - Areliz Chuquimbalqui Maza",
        "020 - Domenica Figueroa Rodriguez",
        "022 - Cielo Guadalupe Pariñas Carranza",
        "023 - Orianka Crespin Ruiz",
        "024 - Ghia Mujica Encizo",
        "025 - Mia Guillen Flores",
        "026 - Jheynny Arirama Amante",
        "027 - Naomi Reyes Napam",
        "031 - Briyith Amasifuen Castro",
        "032 - Anahi Mia Anhuaman",
        "033 - Kiara Chuquizuta Ramos",
        "034 - Alice Matsufiji Cordova",
        "035 - Emyly Huaranga Pobes",
        "040 - Danna Paucar Quispe",
        "041 - Maria Enco Santiesteban",
        "043 - Azumi Trujillo Quilca",
        "045 - Yamilee Torres Choceña",
        "046 - Taewa Cachay",
        "047 - Mia Flores Vallejos",
        "048 - Samantha Valeria Vásquez Fernández",
        "050 - Maylen Mariel Garcia Vilcarromero",
        "052 - María F. Soles Castro",
        "053 - Luana Maciel Rojas Rivera",
        "054 - Noemi Mercedes Ruiz Grijalua",
        "057 - Lyla Huaycama Huertas",
        "058 - Angela Rosario Palomares Marín",
        "059 - Anyolith Sunmi Mayta De la Cruz",
        "060 - Yasumi Viviana Guevara Huantongori",
        "061 - Amy Alessandra Salinas Huaccache",
        "066 - Sara Rojas Salazar",
        "067 - Isis Cabrera Fernandez",
        "068 - Andrea Yanayaco Amao",
        "069 - Francheska Quispe Sánchez",
        "070 - Xiomara Rihana Maira Quispe Espinoza",
        "071 - Anahi Reyna Torrejon",
        "073 - Karen Paola Sandoval Facundo",
        "074 - Dayana Nicole Yarasca Castillos",
        "075 - Maryori Remigio Alfaro",
        "076 - Nahomi Tarazona Ponce"
      ) ~ 2,
      
      record_id %in% c(
        "002 - Percy Rojas Canchari",
        "005 - Aldair Dayiro Contreras Cutamanca",
        "006 - Frank Yensi Julan Pinedo",
        "007 - Fabiano Puchuni Espinoza",
        "008 - Maycol Fernandez Huaman",
        "009 - Pedro Machuca Sanchez",
        "011 - Duban Huaman Carrillo",
        "012 - Diego Mamani Chipani",
        "017 - Jordan Usurin Sarmiento",
        "019 - Moises Enmanuel Ancajima Ybarra",
        "021 - Angel de Jesus Vilela Amamsifuen",
        "028 - Cristian Solis Veliz",
        "029 - Caleb Casabona Vega",
        "030 - Alessandro Tito Toscano",
        "036 - Jann Oliver Estevan Echevarria",
        "037 - Daniel Reyes Santi",
        "038 - Evan Rojas Rojas",
        "039 - Thiago Huarcaya Huaman",
        "042 - Roy Huaron Aranda",
        "044 - Bryan Setalaya Canales",
        "049 - Mathias Adriano Castillo Taipe",
        "051 - Jael Cruz Isidro",
        "055 - Matias Córdova Hancco",
        "056 - Erick Santiago Huaccache Gómez",
        "062 - José María Dylan Núñez Chuchon",
        "063 - Enrique Cruz Luque",
        "064 - Santiago Espinoza Yucra",
        "065 - Jesús Tapullima Chonote",
        "072 - Ameht Paulo Quispe"
      ) ~ 1,
      TRUE ~ NA_real_
    ),
    
    sexo_factor = fct_recode(as.character(sexo), "Masculino" = "1", "Femenino" = "2") |>
      fct_relevel("Masculino", "Femenino"),
    
    # Edad
    edad_anios = coalesce(edad_adolescente, 12),
    edad_meses = edad_anios * 12,
    
    # Peso
    peso_kg = rowMeans(across(c(
      peso_1, peso_2, peso_3
    )), na.rm = TRUE),
    
    # Talla
    talla_cm = rowMeans(pick(talla_1, talla_2, talla_3), na.rm = TRUE),
    talla_m = talla_cm / 100,
    
    # Pliegues
    pliegue_bicipital = rowMeans(across(
      c(
        pliegue_bicipital_1,
        pliegue_bicipital_2,
        pliegue_bicipital_3
      )
    ), na.rm = TRUE), 
    
    pliegue_tricipital = rowMeans(across(
      c(
        pliegue_triceps_1, 
        pliegue_triceps_2, 
        pliegue_triceps_3
      )
    ), na.rm = TRUE), 
    
    pliegue_subescapular = rowMeans(across(
      c(
        pliegue_subescapular_1,
        pliegue_subescapular_2,
        pliegue_subescapular_3
      )
    ), na.rm = TRUE), 
    
    # Perimeters/circumferences
    perimetro_cuello = rowMeans(across(
      c(
        perimetro_cuello_1, 
        perimetro_cuello_2, 
        perimetro_cuello_3
      )
    ), na.rm = TRUE),
    
    perimetro_cintura = rowMeans(across(
      c(
        perimetro_cintura_1,
        perimetro_cintura_2,
        perimetro_cintura_3
      )
    ), na.rm = TRUE), 
    
    perimetro_cadera = rowMeans(across(
      c(
        perimetro_cadera_1, 
        perimetro_cadera_2, 
        perimetro_cadera_3
      )
    ), na.rm = TRUE), 
    
    # Indices
    glucosa_mmol = glucosa / 18.01,
    trigliceridos_mmol  = trigliceridos / 88.57,
    hdl_mmol = hdl_colesterol / 38.67,
    imc = peso_kg / (talla_m^2),
    indice_ponderal = peso_kg / (talla_m^3),
    indice_cintura_talla = perimetro_cintura / talla_cm,
    indice_cintura_cadera = perimetro_cintura / perimetro_cadera,
    TyG = log((trigliceridos * glucosa) / 2), 
    VAI = case_when(
      sexo_factor == "Masculino" ~ (perimetro_cintura / (39.68 + (1.88 * imc))) * 
        (trigliceridos_mmol / 1.03) * (1.31 / hdl_mmol),
      sexo_factor == "Femenino"  ~ (perimetro_cintura / (36.58 + (1.89 * imc))) * 
        (trigliceridos_mmol / 0.81) * (1.52 / hdl_mmol),
      TRUE ~ NA_real_
    ), 
    TyG_WC = TyG * perimetro_cintura,
    TyG_BMI = TyG * imc,
    TyG_WHtR = TyG * indice_cintura_talla,
    TG_HDL_ratio = trigliceridos / hdl_colesterol,
    
    WHtR_cat = if_else(indice_cintura_talla >= 0.5, "Riesgo Abdominal", "Normal"),
    
    TyG_IR = if_else(
      TyG >= 8.19, "Insulinorresistencia", "Sin riesgo"),
    
    WHR_cardio = case_when(
      # 1. Primero filtramos si faltan datos
      is.na(indice_cintura_cadera) | is.na(indice_cintura_cadera) ~ "No evaluado", 
      
      # 2. Definimos ALTO RIESGO (Superan el corte)
      sexo == 1 & indice_cintura_cadera >= 90 ~ "Riesgo", # Hombres
      sexo == 2 & indice_cintura_cadera >= 80 ~ "Riesgo", # Mujeres
      
      # 3. Todo lo demás es NORMAL / SIN RIESGO
      TRUE ~ "Saludable"
    ),
    VAI_higado = if_else(
      VAI > 2.33, "Riesgo de hígado graso asociada a disfunción metabólica",
      "Sin riesgo de hígado graso asociada a disfunción metabólica"),
    
    VAI_sindrome_metabolico = case_when(
      # 1. Primero filtramos si faltan datos
      # is.na(VAI) | is.na(sexo) ~ "No evaluado", 
      is.na(VAI) | is.na(sexo) ~ NA_character_,
      
      # 2. Definimos ALTO RIESGO (Superan el corte)
      sexo == 1 & VAI >= 1.685 ~ "Alto Riesgo", # Hombres
      sexo == 2 & VAI >= 1.875 ~ "Alto Riesgo", # Mujeres
      
      # 3. Todo lo demás es NORMAL / SIN RIESGO
      TRUE ~ "Saludable (Bajo Riesgo)"
    ), 
    
    across(
      c(TyG_WC, TyG_BMI, TyG_WHtR, TG_HDL_ratio),
      ~ cut(
        .,
        breaks = quantile(., probs = seq(0, 1, 0.25), na.rm = TRUE),
        include.lowest = TRUE,
        labels = FALSE
      ),
      .names = "{.col}_q4"
    ), 
    
    TG_HDL_dx = case_when(
    # Si uno de los dos es "Alto", la categoría es "Alto" (prioridad)
      hdl_colesterol >= 130 | trigliceridos >= 200 ~ "Alto",
      
      (hdl_colesterol >= 110 & hdl_colesterol < 130) |
        (trigliceridos >= 170 & trigliceridos < 200) ~ "Límite",
      
      hdl_colesterol < 110 & trigliceridos < 170 ~ "Aceptable"
    ), 
    
    # Sumatoria de pliegues (TR + SE)
    suma_pliegues = (pliegue_tricipital + pliegue_subescapular) / 2,
    
    # Estimación del % de Grasa Corporal (%GC) - Ecuación de Boileau et al. (1985)
    grasa_boileau = case_when(
      sexo_factor == "Masculino" ~ 1.35 * suma_pliegues - 0.012 * (suma_pliegues^2) - 4.4,
      sexo_factor == "Femenino"  ~ 1.35 * suma_pliegues - 0.012 * (suma_pliegues^2) - 4.2,
      TRUE ~ NA_real_
    ),
    
    # Masa Grasa en Kg
    masa_grasa_kg_boileau = (grasa_boileau / 100) * peso_kg,
    
    # Estimación del %GC - Ecuación de Slaughetr et al. (1988)
    grasa_slaughet = case_when(
      sexo_factor == "Masculino" ~ 0.783 * suma_pliegues + 1.6,
      sexo_factor == "Femenino"  ~ 0.546 * suma_pliegues + 9.7,
      TRUE ~ NA_real_
    ),
    
    # Masa Grasa en Kg
    masa_grasa_kg_slaughet = (grasa_slaughet / 100) * peso_kg,
    
    # Variable de sexo codificada para Deurenberg (Hombres=1, Mujeres=0)
    sexo_deurenberg = case_when(
      sexo == 1 ~ 1,
      sexo == 2 ~ 0,
      TRUE ~ NA_real_
    ),
    
    # Estimación del %GC - Ecuación de Deuremberg et al.(1991)
    grasa_deurenberg = (1.51 * imc) - (0.70 * edad_anios) - (3.6 * sexo_deurenberg) + 1.4,
    
    # Masa Grasa en Kg
    masa_grasa_kg_deurenberg = (grasa_deurenberg / 100) * peso_kg,
    
    # Estimación del %GC - Ecuación 1 de Urra et al. (2021)
    grasa_ict = case_when(
      sexo == 1 ~ 9.775 + (0.415 * suma_pliegues) + (35.084 * indice_cintura_talla) -
        (0.828 * edad_anios),
      sexo == 2 ~ 8.608 + (0.291 * suma_pliegues) + (38.893 * indice_cintura_talla) - 
        (0.176 * edad_anios),
      TRUE ~ NA_real_
    ), 
    
    # Masa Grasa en Kg
    masa_grasa_kg_ict = (grasa_ict / 100) * peso_kg,
    
    # Estimación del %GC - Ecuación 2 de Urra et al. (2021)
    grasa_ip = case_when(
      sexo == 1 ~ 20.720 + (0.492 * suma_pliegues) + (0.354 * indice_ponderal) - 
        (0.923 * edad_anios),
      sexo == 2 ~ 16.087 + (0.306 * suma_pliegues) + (0.818 * indice_ponderal) - 
        (0.300 * edad_anios),
      TRUE ~ NA_real_
    ),
    
    # Masa Grasa en Kg
    masa_grasa_kg_ip = (grasa_ip / 100) * peso_kg,
    
    # WC ≥ 95th percentile for age and sex
    sexo_rec = if_else(sexo == 1, "male", "female"),
    
    wc_percentile = sds(
      perimetro_cintura,
      age = edad_anios,
      sex = sexo_rec, male = "male", female = "female",
      item = "wc_sharma",
      ref = us.ref,
      type = "perc"
    ), 
    
    p95_cintura = if_else(wc_percentile >= 0.95, 1, 0),
    p90_cintura = if_else(wc_percentile >= 0.90, 1, 0),
    
    # Z-Scores
    z_scores = anthroplus_zscores(
      sex = sexo,
      age_in_months = edad_meses,
      weight_in_kg = peso_kg,
      height_in_cm = talla_cm
    )
  ) |> 
  tidyr::unpack(z_scores) |>
  mutate(
    zbfa_dx = case_when(
      zbfa > 2 ~ "Obesidad",
      zbfa > 1 ~ "Sobrepeso",
      zbfa < -2 ~ "Delgadez",
      zbfa < -3 ~ "Delgadez Severa",
      TRUE      ~ "Normal"
    ) |>
      ff_label("IMC para la edad (z-score)"),
    zhfa_dx = case_when(
      zhfa < -3 ~ "Talla baja severa",
      zhfa < -2 ~ "Talla baja (Stunting)",
      zhfa > 3  ~ "Talla muy alta (revisar)", 
      is.na(zhfa) ~ "Dato faltante",
      TRUE      ~ "Talla Normal"
    ) |>
      ff_label("Altura para la edad (z-score)"),
    
    # Dinamometria
    dinamometria = pmax(dinamo_1, dinamo_2, dinamo_3, dinamo_max, na.rm = TRUE),
    
    # Presión arterial y frecuencia cardíaca
    PAS = rowMeans(across(
      c(
        pas_1,
        pas_2,
        pas_3
      )
    ), na.rm = TRUE),
    
    PAD = rowMeans(across(
      c(
        pad_1,
        pad_2,
        pad_3
      )
    ), na.rm = TRUE),
    
    pulso = rowMeans(across(
      c(
        pulso_1,
        pulso_2,
        pulso_3
      )
    ), na.rm = TRUE),

    sex_pedbp = ifelse(sexo == 1, 1, 0))

# Pediatric Blood Pressure Distribution
bp_percentiles <- p_bp(
  q_sbp = data_clear$PAS,
  q_dbp = data_clear$PAD,
  age   = data_clear$edad_meses,
  male  = data_clear$sex_pedbp,
  height = data_clear$talla_cm
)

bp_p95_reference <- q_bp(
  p_sbp = 0.95, 
  p_dbp = 0.95,
  age   = data_clear$edad_meses,
  male  = data_clear$sex_pedbp,
  height = data_clear$talla_cm
)

data_clear <- data_clear |>
  mutate(
    crit_tg = if_else(trigliceridos_mmol >= 1.24, 1, 0),
    crit_hdl = if_else(hdl_mmol <= 1.03, 1, 0),
    crit_glucosa = if_else(glucosa_mmol >= 5.6, 1, 0),
    
    # 1. Percentiles (escala 0-100)
    sbp_p = bp_percentiles$sbp_p * 100,
    dbp_p = bp_percentiles$dbp_p * 100,
    
    # 2. Umbrales de referencia
    p95_sbp_mmHg = bp_p95_reference$sbp,
    p95_dbp_mmHg = bp_p95_reference$dbp,
    
    # SBP and/or DBP ≥ 90th percentile for age, sex and height
    p95_bp = if_else(sbp_p >= 95 | dbp_p >= 90, 1, 0),
    p90_bp = if_else(sbp_p >= 90 | dbp_p >= 90, 1, 0),
    
    # 3. Clasificación
    bp_category = case_when(
      # --- REGLA PARA >= 13 AÑOS ---
      edad_anios >= 13 ~ case_when(
        PAS >= 140 | PAD >= 90 ~ "Elevada", # Hipertensión Etapa 2
        PAS >= 130 | PAD >= 80 ~ "Elevada", # Hipertensión Etapa 1
        PAS >= 120 & PAD < 80  ~ "Elevada",
        PAS < 120 & PAD < 80   ~ "Normal",
        TRUE ~ NA_character_
        # TRUE ~ "No clasificado"
      ),
      
      # --- REGLA PARA < 13 AÑOS ---
      edad_anios < 13 ~ case_when(
        # Etapa 2: >= (P95 + 12 mmHg) o >= 140/90
        PAS >= (p95_sbp_mmHg + 12) | PAD >= (p95_dbp_mmHg + 12) | 
          PAS >= 140 | PAD >= 90 ~ "Elevada", # Hipertensión Etapa 2
        
        # Etapa 1: >= P95 hasta < (P95 + 12) o 130/80 a 139/89
        sbp_p >= 95 | dbp_p >= 95 | 
          (PAS >= 130 & PAS < 140) |
          (PAD >= 80 & PAD < 90) ~ "Elevada", # Hipertensión Etapa 1
        
        # Elevada: >= P90 hasta < P95 o >= 120/80
        sbp_p >= 90 | dbp_p >= 90 |  (PAS >= 120 & PAD < 80) ~ "Elevada",
        
        # Normal: < P90 y < 120/80
        !is.na(PAS) & sbp_p < 90 & dbp_p < 90 & PAS < 120 & PAD < 80 ~ "Normal",
        
        TRUE ~ NA_character_
        # TRUE ~ "No clasificado"
      )
    ),
    # Convertimos a factor ordenado para análisis posterior
    bp_category = factor(bp_category) |>
      fct_relevel("Normal", "Elevada") |>
      ff_label("Riesgo cardiovascular"),
    
    # Sumamos los criterios presentes
    n_metabolic_abnormalities = rowSums(across(c(
      p95_cintura, crit_tg, crit_hdl, p90_bp, crit_glucosa)), na.rm = TRUE), 
    
    # Definimos salud metabólica
    metabolic_health = if_else(n_metabolic_abnormalities >= 2, "No saludable", "Saludable"),
    
    # 1. CRITERIOS INDIVIDUALES (Se crean primero)
    cintura_FID = if_else(p90_cintura == 1, 1, 0),
    glucosa_FID = if_else(glucosa >= 100, 1, 0),
    TG_FID = if_else(trigliceridos >= 150, 1, 0),
    HDL_FID = if_else(hdl_colesterol < 40, 1, 0),
    presion_FID = if_else(PAS >= 130 | PAD >= 85, 1, 0),
    
    # 2. CONTEO DE CRITERIOS SECUNDARIOS
    n_criterios_secundarios = rowSums(
      across(c(glucosa_FID, TG_FID, HDL_FID, presion_FID)), 
      na.rm = TRUE
    ),
    
    # 3. VARIABLE FINAL: Síndrome Metabólico (FID)
    sindrome_metabolico = case_when(
      # Debe tener Cintura >= P90 Y al menos 2 más
      cintura_FID == 1 & n_criterios_secundarios >= 2 ~ "Sí",
      
      # Si no cumple la cintura O tiene menos de 2 secundarios
      cintura_FID == 0 | n_criterios_secundarios < 2 ~ "No",
      
      # Para cualquier otro caso (datos faltantes)
      TRUE ~ NA_character_
    ) |>
      fct_relevel("No", "Sí"),

    # Variable de riesgo (Binaria)
    riesgo_aterogenico = case_when(
      TG_HDL_ratio >= 2.2 ~ "Riesgo",
      TG_HDL_ratio < 2.2 ~ "Normal",
      TRUE ~ NA_character_
    ) |>
      fct_relevel("Normal", "Riesgo") |>
      ff_label("Dislipidemia aterogénica"),

    # Variable combinada con Glucosa (IFG)
    # IFG: Impaired Fasting Glucose (Glucosa entre 100 y 125 mg/dL)
    perfil_aterogenico_ifg = case_when(
      TG_HDL_ratio >= 2.2 & glucosa >= 100 ~ "Riesgo Mixto (Lípidos + Glucosa)",
      TG_HDL_ratio >= 2.2 ~ "Solo Riesgo Lipídico",
      glucosa >= 100 ~ "Solo Glucosa Alterada (IFG)",
      TG_HDL_ratio < 2.2 & glucosa < 100 ~ "Sin Riesgo",
      TRUE ~ NA_character_
    ) |>
      fct_relevel(
        "Sin Riesgo", "Solo Glucosa Alterada (IFG)", 
        "Solo Riesgo Lipídico", "Riesgo Mixto (Lípidos + Glucosa)") |>
      ff_label("Dislipidemia aterogénica y glucemia en ayunas alterada"),
    
    # 1. Preparar variables en las unidades correctas
    cintura_m = perimetro_cintura / 100,
    
    # 3. Aplicar la fórmula del ABSI
    # ABSI = WC / (BMI^(2/3) * Height^(1/2))
    absi = cintura_m / ((imc^(2 / 3)) * (talla_m^(1 / 2))),
      
    absi = ff_label(absi, "Índice de forma corporal (ABSI)"), 
    
    # Depression
    across(
      sintomas_depresivos_1:sintomas_depresivos_9,
      ~ case_match(
        .x,
        "Nunca" ~ 0,
        "Varios días" ~ 1,
        "Más de la mitad de los días" ~ 2,
        "Casi todos los días" ~ 3
      )
    ),
    
    PHQ_9 = rowSums(across(sintomas_depresivos_1:sintomas_depresivos_9), na.rm = TRUE),
    
    depresion = case_when(
      PHQ_9 <= 4 ~ "Mínima",
      PHQ_9 >= 5 & PHQ_9 <= 9 ~ "Leve",
      PHQ_9 >= 10 & PHQ_9 <= 14 ~ "Moderada",
      PHQ_9 >= 15 & PHQ_9 <= 19 ~ "Moderadamente severa",
      PHQ_9 >= 20 ~ "Severa",
      TRUE ~ NA_character_) |>
      fct_relevel(
        "Mínima", "Leve", "Moderada", "Moderadamente severa", "Severa"),
    
    # Ansiedad
    across(
      sintomas_ansiedad_1:sintomas_ansiedad_10,
      ~ case_match(
        .x,
        "Nunca" ~ 0,
        "Ocasionalmente" ~ 1,
        "Mitad del tiempo" ~ 2,
        "La mayor parte del tiempo" ~ 3,
        "Todo el tiempo" ~ 4
      )
    ),
    
    GAD_7 = rowSums(across(sintomas_ansiedad_1:sintomas_ansiedad_7), na.rm = TRUE),
    
    ansiedad = case_when(
      GAD_7 <= 4 ~ "Mínima",
      GAD_7 >= 5 & GAD_7 < 10 ~ "Leve",
      GAD_7 >= 10 & GAD_7 < 15 ~ "Moderada",
      GAD_7 >= 15 ~ "Severa",
      TRUE ~ NA_character_) |>
      fct_relevel(
        "Mínima", "Leve", "Moderada", "Severa"),
  
    # Nutricion
    across(
      .cols = starts_with("nutricion") &
        !all_of(
          c(
            "nutricion_3",
            "nutricion_8",
            "nutricion_14",
            "nutricion_18",
            "nutricion_21"
          )
        ),
      .fns = ~ case_match(
        .x,
        "Verdadero" ~ 1,
        "Falso"     ~ 0,
        "Nunca"     ~ NA_real_
      )
    ), # 2. Preguntas con puntaje inverso (V=0, F=1)
    across(
      .cols = all_of(
        c(
          "nutricion_3",
          "nutricion_8",
          "nutricion_14",
          "nutricion_18",
          "nutricion_21"
        )
      ),
      .fns = ~ case_match(
        .x,
        "Verdadero" ~ 0,
        "Falso"     ~ 1,
        "Nunca"     ~ NA_real_
      )
    ))

data_clear <- data_clear |>
  rowwise() |>
  mutate(
    
    # Contar cuántas respuestas saludables (1s) obtuvo el sujeto
    n_saludables = sum(c_across(starts_with("nutricion")), na.rm = TRUE),
    
    # Contar cuántas preguntas respondió (excluyendo NAs y "No aplicable")
    n_completados = sum(!is.na(c_across(starts_with("nutricion")))),
    
    # Aplicar la fórmula de ajuste del manual
    afhc_score = n_saludables * (23 / n_completados)) |>
  ungroup()

data_clear <- data_clear |>
  mutate(   
    
    categoria_afhc = if_else(afhc_score >= 11, "Saludable", "No saludable"),
    
    # PAQ-C
    across(
    c(paqc_1, paqc_2, paqc_3, paqc_4, paqc_5, paqc_6, paqc_7), ~ as.numeric(.x)),
    
    d1 = obtener_puntaje_dia(
      paqc_8_1_ninguna,
      paqc_8_1_a_veces,
      paqc_8_1_regular,
      paqc_8_1_frecuente,
      paqc_8_1_muy_frecuente
    ), 
    d2 = obtener_puntaje_dia(
      paqc_8_2_ninguna,
      paqc_8_2_a_veces,
      paqc_8_2_regular,
      paqc_8_2_frecuente,
      paqc_8_2_muy_frecuente
    ), 
    d3 = obtener_puntaje_dia(
      paqc_8_3_ninguna,
      paqc_8_3_a_veces,
      paqc_8_3_regular,
      paqc_8_3_frecuente,
      paqc_8_3_muy_frecuente
    ), 
    d4 = obtener_puntaje_dia(
      paqc_8_4_ninguna,
      paqc_8_4_a_veces,
      paqc_8_4_regular,
      paqc_8_4_frecuente,
      paqc_8_4_muy_frecuente
    ), 
    d5 = obtener_puntaje_dia(
      paqc_8_5_ninguna,
      paqc_8_5_a_veces,
      paqc_8_5_regular,
      paqc_8_5_frecuente,
      paqc_8_5_muy_frecuente
    ), 
    d6 = obtener_puntaje_dia(
      paqc_8_6_ninguna,
      paqc_8_6_a_veces,
      paqc_8_6_regular,
      paqc_8_6_frecuente,
      paqc_8_6_muy_frecuente
    ), 
    d7 = obtener_puntaje_dia(
      paqc_8_7_ninguna,
      paqc_8_7_a_veces,
      paqc_8_7_regular,
      paqc_8_7_frecuente,
      paqc_8_7_muy_frecuente
    ), 
    
    # 1. Calculamos primero el promedio del ítem 9 (días de la semana)
    paq_item9_score = rowMeans(across(c(d1, d2, d3, d4, d5, d6, d7)), na.rm = TRUE),

    # 2. Calculamos el score final incluyendo el ítem 9 ya procesado
    paqc_final_score = rowMeans(across(c(
      paqc_1, paqc_2, paqc_3, paqc_4, paqc_5, paqc_6, paqc_7, paq_item9_score
    )), na.rm = TRUE),
    
    # 3. Diagnóstico corregido (Sin saltos entre números)
    paqc_dx = case_when(
      paqc_final_score < 2 ~ "Actividad Baja",
      paqc_final_score >= 2 & paqc_final_score < 4 ~ "Actividad Moderada",
      paqc_final_score >= 4 ~ "Actividad Alta",
      TRUE ~ NA_character_
    ) |>
      fct_relevel("Actividad Alta", "Actividad Moderada", "Actividad Baja"),
    
    across(
      c(fvc, fvc_2, fvc_3, fvc_4, fvc_5, fvc_6, fvc_7, fvc_8,
        fev1, fev1_2, fev1_3, fev1_4, fev1_5, fev1_6, fev1_7, fev1_8,
        pef, pef_2, pef_3, pef_4, pef_5, pef_6, pef_7, pef_8,
        fev3, fev3_2, fev3_3, fev3_4, fev3_5, fev3_6, fev3_7, fev3_8,
        fev6, fev6_2, fev6_3, fev6_4, fev6_5, fev6_6, fev6_7, fev6_8),
      ~ as.numeric(ifelse(.x == "NI" | .x == "999", NA, .x))
    ),
    # FVC
    fvc_maximo = pmax(
      fvc, fvc_2, fvc_3, fvc_4, fvc_5, fvc_6, fvc_7, fvc_8, na.rm = TRUE),

    # FEV1
    fev1_maximo = pmax(
      fev1, fev1_2, fev1_3, fev1_4, fev1_5, fev1_6, fev1_7, fev1_8, na.rm = TRUE),

    # PEF
    pef_maximo = pmax(
      pef, pef_2, pef_3, pef_4, pef_5, pef_6, pef_7, pef_8, na.rm = TRUE),

    # FEV3
    fev3_maximo = pmax(
      fev3, fev3_2, fev3_3, fev3_4, fev3_5, fev3_6, fev3_7, fev3_8, na.rm = TRUE),

    # FEV6
    fev6_maximo = pmax(
      fev6, fev6_2, fev6_3, fev6_4, fev6_5, fev6_6, fev6_7, fev6_8, na.rm = TRUE),

    # Calcular el índice FEV1/FVC
    fev1_fvc_ratio = fev1_maximo / fvc_maximo,

    # Ajustamos el sexo para rspiro (1=M, 2=F)
    sex_rspiro = if_else(sexo == 1, 1, 2),

    # 2. Cálculos de Z-score GLI (Usando talla_cm)
    z_fev1 = zscore_GLI(
      age = edad_anios, 
      height = talla_m, 
      gender = sex_rspiro, 
      ethnicity = 5, 
      FEV1 = fev1_maximo),
    
    z_fvc  = zscore_GLI(
      age = edad_anios, 
      height = talla_m, 
      gender = sex_rspiro, 
      ethnicity = 5, 
      FVC = fvc_maximo),
    
    z_fev1_fvc = zscore_GLI(
      age = edad_anios,
      height = talla_m, 
      gender = sex_rspiro, 
      ethnicity = 5, 
      FEV1FVC = fev1_fvc_ratio),

    # 3. Conversión a Percentiles
    fev1_p = pnorm(z_fev1) * 100, 
    fvc_p  = pnorm(z_fvc) * 100, 
    fev1_fvc_p = pnorm(z_fev1_fvc) * 100, 
    
    # 4. Clasificación Clínica
    # El percentil 5 es el Límite Inferior de Normalidad (LLN)
    clasificacion_espiro = case_when(
      # Si faltan datos, que lo diga claramente
      is.na(fev1_fvc_p) | is.na(fvc_p) ~ "Datos insuficientes",
      
      # Patrón obstructivo (FEV1/FVC disminuido)
      fev1_fvc_p <= 5 & fvc_p > 5 ~ "Sugerente de Obstrucción",
      
      # Patrón Restrictivo (FEV1/FVC normal, FVC disminuido)
      fev1_fvc_p > 5 & fvc_p <= 5 ~ "Sugerente de Restricción",
      
      # Mixto (Patron obstructivo con FVC disminuido)
      fev1_fvc_p <= 5 & fvc_p <= 5 ~ "Mixto",
      
      # Normal (Ambos por encima del percentil 5)
      fev1_fvc_p > 5 & fvc_p > 5 ~ "Normal",
      
      TRUE ~ "Revisar caso"
    ), 
    
    # Cálculo del % del Predicho (Opcional, muy usado en clínica)
    # La función pctpred da el valor: (Medido / Predicho) * 100
    fev1_pct_pred = pctpred_GLI(
      age = edad_anios,
      height = talla_m,
      gender = sex_rspiro,
      ethnicity = 5,
      FEV1 = fev1_maximo
    ),
    
    # Cluster de PM2.5
    cluster = case_match(
      colegio_id, 
      c("Colegio Jorge Basadre - VMT", "Colegio Santísima Virgen de Chapi - Pachacamac") ~
        "VMT y Pachacamac",
      "Colegio 0028 Jesus y María - La Molina" ~ "La Molina"),
    
    pariente_del_infante = factor(pariente_del_infante) |>
      fct_recode(
        "Otro" = "Padre",
        "Otro" = "Otro pariente (especifique): {pariente_del_infante_2}") |>
      fct_relevel("Madre", "Otro") |>
      ff_label("Pariente"),
    
    edad_pariente = ff_label(edad_pariente, "Edad del Pariente"),
    
    estado_civil_pariente = case_match(
      estado_civil_pariente, 
      c("Soltero(a)", "Casado(a)") ~ "Soltero(a) o casado(a)",
      c("Separado(a)", "Divorciado(a)", "Viudo(a)", "Prefiero no responder") ~ "Otro",
      .default = estado_civil_pariente) |>
      fct_relevel("Conviviente", "Soltero(a) o casado(a)", "Otro") |>
      ff_label("Estado civil"),
    
    nivel_educativo_pariente = case_match(
      nivel_educativo_pariente, 
      c("Inicial", "Primaria") ~ "Primaria",
      c("Técnica", "Universitaria") ~ "Superior",
      .default = nivel_educativo_pariente) |>
      fct_relevel("Primaria", "Secundaria", "Superior") |>
      ff_label("Nivel educativo del pariente"),
    
    across(starts_with("sit_economica"), ~na_if(., "Prefiere no responder")),
    
    nivel_economico = case_when(
      # NIVEL ALTO: Viven con comodidad o ganan más de S/. 3390
      sit_economica_1 %in% c("Viven con comodidad", "Les alcanza bien") | 
      sit_economica_3 %in% c("Entre S/. 3391 y S/. 4520", "Más de 4521") ~ "Alto/Suficiente",

      # NIVEL BAJO: Dificultad para cubrir gastos o ganan menos del mínimo (S/. 1130)
      sit_economica_1 %in% c("Les resulta algo difícil cubrir los gastos", 
                             "Les resulta muy difícil cubrir los gastos") | 
      sit_economica_3 == "Menos de S/. 1130" ~ "Bajo/Vulnerable",

      # NIVEL MEDIO: Se las arreglan o ingresos intermedios
      sit_economica_1 == "Se las arreglan con lo que tienen" | 
      sit_economica_3 %in% c("Entre S/.1131 y S/.2260", "Entre S/. 2261 y S/. 3390") ~ "Medio",

      # Mantener los NAs
      TRUE ~ NA_character_
    ) |>
      fct_relevel("Alto/Suficiente", "Medio", "Bajo/Vulnerable") |>
      ff_label("Situación económica"),
    
    ano_residencia = ntile(ano_residencia, 4),
    ano_residencia = factor(ano_residencia) |>
      fct_recode(
        "0-5 años" = "1", 
        "6-10 años" = "2", 
        "11-18.5 años" = "3", 
        "Más de 18.5 años" = "4") |>
      fct_relevel("0-5 años", "6-10 años", "11-18.5 años", "Más de 18.5 años") |>
      ff_label("Años de residencia"),
    
    orden_del_hijo = case_match(
      orden_del_hijo, 
      "Primer hijo(a)" ~ "Primero",
      "Segundo hijo(a)" ~ "Segundo",
      c("Tercer hijo(a)", "Cuarto hijo(a)", "Quinto hijo(a)", "Sexto hijo(a)", 
        "Más de seis hijos(as)") ~ "Tercero en adelante",
      .default = orden_del_hijo) |>
      fct_relevel("Primero", "Segundo", "Tercero en adelante") |>
      ff_label("Orden del hijo"),
    
    # Duración total de la lactancia
    lm_duracion_total = case_when(
      lactancia_materna == "No" ~ 0,
      !is.na(as.numeric(lactancia_materna_2_meses)) ~ as.numeric(lactancia_materna_2_meses),
      TRUE ~ NA_real_) |>
      ff_label("Duración total de la lactancia (meses)"), 
    
    # Lactancia materna exclusiva (LME) según OMS: Sin fórmula ni sólidos antes de los 6 meses
    lme_6meses = case_when(
      # Si nunca tomó fórmula o empezó fórmula a los 6 meses o más
      (
        lactancia_materna_3 == "Nunca tomó fórmula" |
          as.numeric(lactancia_materna_3_meses) >= 6
      ) &
        (as.numeric(lactancia_materna_4_meses) >= 6) ~ "Sí",
      
      # Si tomó fórmula antes de los 6 meses o sólidos antes de los 6 meses
      as.numeric(lactancia_materna_3_meses) < 6 |
        as.numeric(lactancia_materna_4_meses) < 6 ~ "No",
      
      TRUE ~ NA_character_
    ) |>
      fct_relevel("Sí", "No") |>
      ff_label("Lactancia materna exclusiva"), 
    
    # Inicio de la alimentación complementaria
    edad_solidos = case_match(
      lactancia_materna_4_meses, 4 ~ "Antes de 6 meses",
      6 ~ "A los 6 meses", c(7, 8, 12) ~ "Después de 6 meses") |>
      fct_relevel("Antes de 6 meses", "A los 6 meses", "Después de 6 meses") |>
      ff_label("Inicio de alimentación complementaria"),
    
    enfermedad_pulmonar = case_when(
      enf_pulmonares_rinitis_alergica == "Yes" ~ "Rinitis alérgica",
      enf_pulmonares_asma == "Yes" ~ "Asma",
      enf_pulmonares_bronquitis_cronica == "Yes" ~ "Bronquitis crónica",
      enf_pulmonares_ninguna == "Yes" ~ "Ninguna",
      TRUE ~ NA_character_) |>
      fct_relevel(
        "Rinitis alérgica", "Asma", "Bronquitis crónica", "Ninguna") |>
      ff_label("Enfermedades pulmonares"),
    
    across(c(exposoma_1_5b, exposoma_2_5b), ~ as.numeric(replace(.x, .x == "04", 4))),
    
    across(
      alergia_pteronyssinus:alergia_olivo,
      ~ case_match(.x, "Negativo" ~ "No", "Positivo" ~ "Sí")
    ),
    
    across(c(
      asma, rinitis_alergica, lme_6meses, edad_solidos, hospitalizado_nino_nacer,
      enf_bajopeso_prematuro, enf_macrosomia, enf_dm1, enf_resit_insulina, 
      enf_dislipidemias, inf_respirat_recurrentes, hospita_previas, vacunas,
      ant_familiar_pulmon, ant_diabetes2, ant_hta, ant_fenf_cardiov, 
      ant_dislipidemias, ant_cancer, ant_obesidad, ant_familiar_otros), 
      ~ fct_recode(.x, "Sí" = "Sí")),
    
    # --- MÓDULO ASMA ---
    # Prevalencia de vida: ¿Alguna vez pitos?
    asma_vida = if_else(isaac_asma_21 == "Sí", "Sí", "No", missing = "No"),
    
    # Prevalencia actual: Pitos en los últimos 12 meses (Indicador clave)
    asma_actual = if_else(isaac_asma_22 == "Sí", "Sí", "No", missing = "No"),
    
    # Asma Severa (Definición ISAAC): 
    # Tener asma actual Y (>=4 ataques O despertarse >=1 noche/semana O habla limitada)
    asma_severa = case_when(
      asma_actual == "No" ~ "No",
      asma_actual == "Sí" & (
        isaac_asma_23 %in% c("4 a 12", "Más de 12") | 
          isaac_asma_24 == "Una o más noches por semana" | 
          isaac_asma_25 == "Sí") ~ "Sí",
      TRUE ~ "No"
    ),
    
    # --- MÓDULO RINITIS ---
    rinitis_vida = if_else(isaac_rinitis_29 == "Sí", "Sí", "No", missing = "No"),
    rinitis_actual = if_else(isaac_rinitis_30 == "Sí", "Sí", "No", missing = "No"),
    
    # Rinoconjuntivitis (Síntomas nasales + ojos llorosos/picor)
    rinoconjuntivitis = if_else(
      rinitis_actual == "Sí" & isaac_rinitis_33 == "Sí", "Sí", "No", missing = "No"),

    # --- MÓDULO DERMATITIS ---
    eczema_vida = if_else(isaac_dermatitis_35 == "Sí", "Sí", "No", missing = "No"),
    eczema_actual = if_else(isaac_dermatitis_36 == "Sí", "Sí", "No", missing = "No"),
    
    PM2_5 = case_when(
      colegio_id == "Colegio Jorge Basadre - VMT" ~ "28.96 (2.35)",
      colegio_id == "Colegio Santísima Virgen de Chapi - Pachacamac" ~ "32.94 (2.57)",
      colegio_id == "Colegio 0028 Jesus y María - La Molina" ~ "26.83 (2.62)",
      TRUE ~ NA_character_ # Importante: usar character porque ahora es texto
    ) |>
    ff_label("PM2.5")
  )

# ?saveRDS(data_clear, here("data", "data_shiny.rds"))
```

```{r}
#| eval: false
#| include: false
comprobacion_espiro <- data_clear |> dplyr::select(record_id, fev1_maximo, z_fev1, fvc_maximo, z_fvc, fev1_fvc_ratio, z_fev1_fvc, clasificacion_espiro, talla_m, sex_rspiro)

comprobacion_espiro
```

## Tabla 1. Características socioeconómicas del pariente

```{r}
tbl_1 <- data_clear |>
  dplyr::select(
    PM2_5, pariente_del_infante, edad_pariente, estado_civil_pariente,
    nivel_educativo_pariente, nivel_economico, seguro_de_salud_adolescente, 
    ano_residencia, orden_del_hijo, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    type = list(PM2_5 ~ "continuous"),
    # Usamos una función que simplemente devuelve el primer valor encontrado
    statistic = list(PM2_5 ~ "{max}"), 
    # Forzamos a que PM2_5 sea tratado como texto puro en el formato
    digits = list(PM2_5 ~ function(x) x), 
    label = list(
      seguro_de_salud_adolescente ~ "Seguro de Salud del adolescente",
      PM2_5 ~ "PM2.5"
    ),
    missing = "ifany"
  ) |>
  add_overall() |>
  # Excluimos PM2_5 de add_p para evitar errores de cálculo
  add_p(
    include = -PM2_5,
    pvalue_fun = ~style_pvalue(.x, digits = 3)
  ) |>
  bold_p(t = 0.05) |>
  modify_header(
    all_stat_cols() ~ "**{level}** (n = {n})",
    label = "**Características**",
    stat_0 = "**Total** (n = {n})"
  ) |>
  modify_spanning_header(all_stat_cols(stat_0 = FALSE) ~ "**Colegio**")
```

## Tabla 2. Antecedentes de la primera infancia y actuales

```{r}
tbl_2 <- data_clear |>
  dplyr::select(
    lm_duracion_total, lme_6meses, edad_solidos,
    hospitalizado_nino_nacer, enf_bajopeso_prematuro, enf_macrosomia, 
    enfermedad_pulmonar, enf_dm1, enf_resit_insulina, enf_dislipidemias, 
    inf_respirat_recurrentes, hospita_previas, vacunas, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical()~ c(1, 1)),
    label = list(
      hospitalizado_nino_nacer ~ "Hospitalización al nacer",
      enf_bajopeso_prematuro ~ "Bajo peso al nacer o prematuridad (37 semanas)",
      enf_macrosomia ~ "Macrosomía (peso > 4 Kg al nacer)",
      enf_dm1 ~ "Diabetes Mellitus tipo 1",
      enf_resit_insulina ~ "Resistencia a la insulina",
      enf_dislipidemias ~ "Dislipidemia",
      inf_respirat_recurrentes  ~ "Infecciones respiratorias recurrentes",
      hospita_previas ~ "Hospitalizaciones previas este año",
      vacunas ~ "Vacunas al día este año"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_p(t = 0.05) 
```

## Tabla 3. Antecedentes familiares

```{r}
tbl_3 <- data_clear |>
  dplyr::select(
    ant_familiar_pulmon, ant_diabetes2, ant_hta, ant_fenf_cardiov, ant_dislipidemias,
    ant_cancer, ant_obesidad, ant_familiar_otros, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical()~ c(1, 1)),
    label = list(
      ant_familiar_pulmon ~ "Enfermedad pulmonar",
      ant_diabetes2 ~ "Diabetes mellitus tipo 2",
      ant_hta ~ "HTA",
      ant_fenf_cardiov ~ "CVD",
      ant_dislipidemias ~ "Dislipidemias",
      ant_cancer ~ "Cáncer",
      ant_obesidad ~ "Obesidad",
      ant_familiar_otros ~ "Otros"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_p(t = 0.05) 
```

## Tabla 4. Salud mental, nutrición y actividad física

```{r}
tbl_4 <- data_clear |>
  dplyr::select(ansiedad_1, ansiedad_2, depresion_1, depresion_2, PHQ_9,
    depresion, PHQ_9, depresion, GAD_7, ansiedad, afhc_score, dinamometria,
    categoria_afhc, paqc_final_score, paqc_dx, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical()~ c(1, 1)),
    label = list(
      ansiedad_1 ~ "Nerviosismo del pariente",
      ansiedad_2 ~ "Preocupación del pariente",
      depresion_1 ~ "Apatía o anhedonia del pariente",
      depresion_2 ~ "Depresión del pariente",
      PHQ_9 ~ "Puntaje del PHQ-9",
      depresion ~ "Gravedad de la depresión",
      GAD_7 ~ "Puntaje del GAD-7",
      ansiedad ~ "Trastorno de Ansiedad Generalizada",
      afhc_score ~ "Puntaje del AFHS",
      categoria_afhc ~ "Hábitos alimentarios para adolescentes",
      paqc_final_score ~ "Puntaje del PAQ-A",
      paqc_dx ~ "Actividad física para adolescentes",
      dinamometria ~ "Dinapenia"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_p(t = 0.05)
```

## Tabla 5. Exposoma

```{r}
# tbl_5 <- data_clear |>
#   dplyr::select(exposoma_1_1a:exposoma_2_6b, colegio_id) |>
#   tbl_summary(
#     by = colegio_id,
#     type = list(everything() ~ "continuous"),
#     digits = list(all_continuous() ~ 1), 
#     statistic = list(everything() ~ "{median} ({p25}, {p75})"),
#     missing = "ifany"
#   ) |>
#   add_overall() |>
#   add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
#   bold_p(t = 0.05)
```

## Tabla 6. Alergias, asma y rinitis

```{r}
tbl_6 <- data_clear |>
  dplyr::select(
    alergia_pteronyssinus, alergia_farinae, alergia_destructor, 
    alergia_tropicalis, alergia_perro, alergia_germanica, asma, rinitis_alergica,
    feno, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical() ~ c(1, 1)),
    label = list(
      alergia_pteronyssinus ~ "Dermatophagoides pteronyssinus (polvo)",
      alergia_farinae ~ "Dermatophagoides farinae (polvo)",
      alergia_destructor ~ "Alergia a Lepidoglyphus destructor (ácaro)",
      alergia_tropicalis ~ "Alergia a Blomia tropicalis (ácaro)",
      alergia_perro ~ "Alergia al perro",
      alergia_germanica ~ "Alergia a cucaracha chiquita",
      asma ~ "Asma",
      rinitis_alergica ~ "Rinitis alérgica",
      feno ~ "Fracción Exhalada de Óxido Nítrico (FeNO)"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_p(t = 0.05)
```

## Tabla 7. International Study of Asthma and Allergies in Childhood (ISAAC)

```{r}
tbl_7 <- data_clear |>
  select(
    asma_vida, asma_actual, asma_severa, rinitis_actual, rinoconjuntivitis, 
    eczema_actual, colegio_id) |>
  tbl_summary(
    by = colegio_id, # Si quieres comparar por tus grupos de salud metabólica
    label = list(
      asma_vida ~ "Sibilancias alguna vez",
      asma_actual ~ "Sibilancias últimos 12 meses",
      asma_severa ~ "Asma con síntomas de severidad",
      rinitis_actual ~ "Rinitis actual (12m)",
      rinoconjuntivitis ~ "Rinoconjuntivitis alérgica",
      eczema_actual ~ "Eczema/Dermatitis actual"
    ),
    missing = "no"
  ) |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_p(t = 0.05)
```

## Tabla 8. Biomarcadores

```{r}
tbl_8 <- data_clear |>
  dplyr::select(
    glucosa, trigliceridos, hdl_colesterol, colesterol_total, PAS, PAD, pulso,
    TyG, VAI, metabolic_health, bp_category, TyG_IR, TG_HDL_dx, WHR_cardio,
    VAI_sindrome_metabolico, sindrome_metabolico, riesgo_aterogenico, 
    colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(all_continuous() ~ c(2, 2)),
    label = list(
      glucosa ~ "Glucosa en ayunas (mg/dL)",
      trigliceridos ~ "Triglicéridos (mg/dL)",
      hdl_colesterol ~ "HDL-c (mg/dL)",
      colesterol_total ~ "Colesterol total (mg/dL)",
      PAS ~ "Presión arterial sistólica (mmHg)",
      PAD ~ "Presión arterial diastólica (mmHg)",
      pulso ~ "Pulso cardíaco (latidos por minuto)",
      TyG ~ "Índice triglicéridos-glucosa (TyG)",
      VAI ~ "Índice de adiposidad visceral (VAI)",
      metabolic_health ~ "Fenotipo metabólico"
      ),
    missing = "no") |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_labels() |>
  bold_p(t = 0.05)
```

```{r}
#| eval: false
tbl_1 <- data_clear |>
  dplyr::select(ataque_corazon:estornudos)

lapply(tbl_1 , function(x) addmargins(table(x, useNA = "ifany")))
```

## Tabla 9. Antropometría

```{r}
tbl_9 <- data_clear |>
  dplyr::select(
    sexo_factor, edad_anios, peso_kg, talla_m, peso_kg, imc, zbfa_dx, zhfa_dx,
    pliegue_bicipital, pliegue_tricipital, pliegue_subescapular, perimetro_cuello,
    colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(all_continuous() ~ c(2, 2), all_categorical() ~ c(1, 1)),
    statistic = list(all_categorical() ~"{n} ({p}%)"),
    label = list(
      sexo_factor	~ "Sexo",
      edad_anios ~ "Edad (años)",
      peso_kg ~ "Peso (Kg)",
      talla_m	~ "Talla (metros)",
      imc ~ "IMC",
      pliegue_bicipital	~ "Pliegue bicipital (mm)",
      pliegue_tricipital ~ "Pliegue tricipital (mm)",
      pliegue_subescapular ~ "Pliegue subescapular (mm)",
      perimetro_cuello ~ "Perímetro del cuello (cm)"
      ), 
    missing = "no") |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_labels() |>
  bold_p(t = 0.05)
```

## Tabla 10. Índices

```{r}
tbl_10 <- data_clear |>
  dplyr::select(
    perimetro_cintura, perimetro_cadera, indice_cintura_cadera, indice_cintura_talla, 
    TyG_WC, TyG_BMI, TyG_WHtR, TG_HDL_ratio, WHtR_cat, absi, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(all_continuous() ~ c(2, 2), all_categorical() ~ c(1, 1)),
    statistic = list(all_categorical() ~"{n} ({p}%)"),
    label = list(
      perimetro_cintura	~ "Perímetro de cintura (cm)",
      perimetro_cadera	~ "Perímetro de cadera (cm)",
      indice_cintura_cadera	~ "Índice cintura-cadera",
      indice_cintura_talla ~ "Índice cintura-altura (ICT)",
      TyG_WC ~ "TyG-Circunferencia de la cintura",
      TyG_BMI ~ "TyG-IMC",
      TyG_WHtR ~ "TyG-ICT",
      TG_HDL_ratio ~ "TyG-HDL"
      ),
    missing = "no") |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_labels() |>
  bold_p(t = 0.05)
```

## Tabla 11. Grasa corporal

```{r}
tbl_11 <- data_clear |>
  dplyr::select(
    grasa_boileau, grasa_slaughet, grasa_deurenberg, grasa_ict, grasa_ip, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(all_continuous() ~ c(2, 2), all_categorical() ~ c(1, 1)),
    statistic = list(all_categorical() ~"{n} ({p}%)"),
    label = list(
      grasa_boileau ~ "%GC Boileau et al. (1985)",
      grasa_slaughet ~ "%GC Slaughetr et al. (1988)",
      grasa_deurenberg ~ "%GC Deuremberg et al.(1991)",
      grasa_ict ~ "%GC ICT",
      grasa_ip ~ "%GC índice ponderal"
      ),
    missing = "no") |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_labels() |>
  bold_p(t = 0.05)
```

## Tabla 12. Espirometría

```{r}
tbl_12 <- data_clear |>
  dplyr::select(
    fvc_maximo, fev1_maximo, pef_maximo, fev1_fvc_ratio, clasificacion_espiro,
    colegio_id) |>
  tbl_summary(
    by = colegio_id,
    digits = list(all_continuous() ~ c(2, 2), all_categorical() ~ c(1, 1)),
    statistic = list(all_categorical() ~"{n} ({p}%)"),
    label = list(
      fvc_maximo ~ "Capacidad Vital Forzada (FVC)",
      fev1_maximo ~ "Volumen Espiratorio Forzado en el Primer Segundo (FEV1)",
      pef_maximo ~ "Pico Espiratorio Forzado (PEF)",
      fev1_fvc_ratio ~ "Índice FEV1/FVC",
      clasificacion_espiro ~ "Clasificación clínica (LLN)"
      ),
    missing = "no") |>
  add_overall() |>
  add_p(pvalue_fun = ~style_pvalue(.x, digits = 3)) |>
  bold_labels() |>
  bold_p(t = 0.05)
```

## Matriz de correlacion

```{r fig.height=20, fig.width=20, fig.align = 'center'}
cor_data <- data_clear |>
  dplyr::select(
    edad_anios, peso_kg, talla_m, glucosa, PAS, PAD, pulso, 
    pliegue_bicipital, pliegue_tricipital, pliegue_subescapular, 
    perimetro_cuello, perimetro_cintura, perimetro_cadera,
    indice_ponderal, indice_cintura_talla, indice_cintura_cadera,
    TyG, VAI, TyG_WC, TyG_BMI, TyG_WHtR, TG_HDL_ratio, suma_pliegues, 
    grasa_boileau, grasa_slaughet, grasa_deurenberg, grasa_ict, grasa_ict,
    grasa_ip, zbfa, zhfa, absi, dinamometria, afhc_score,
    paqc_final_score) |>
  na.omit()
  # rename(
  #   "Glucosa en ayunas (mg/dL)" = glucosa, 
  #   "Triglicéridos (mg/dL)" = trigliceridos, 
  #   "HDL-c (mg/dL)" = hdl_colesterol,
  #   "Colesterol total (mg/dL)" = colesterol_total,
  #   "Presión arterial sistólica (mmHg)" = PAS,
  #   "Presión arterial diastólica (mmHg)" = PAD,
  #   "Pulso cardíaco (latidos por minuto)" = pulso,
  #   "Índice triglicéridos-glucosa (TyG)" = TyG,
  #   "Índice de adiposidad visceral (VAI)" = VAI)

cor_spearman = round(cor(cor_data, method = "spearman"), 2)
# cor_spearman[abs(cor_spearman) < 0.5] <- NA
# rcorr(as.matrix(cor_data))

corrplot(
  cor_spearman,
  type = "lower",
  method = "ellipse",
  pch.col = "black",
  na.label.col = "black",
  tl.col = "black",
  addCoef.col = "black",
  diag = FALSE,
  col = colorRampPalette(c("#8787FFFF", "white", "#FF5959FF"))(100),
  sig.level = 0.05, 
  insig = "blank",
  mar = c(0, 0, 1, 0)
)
```

# Tablas unidas

```{r}
# Stack tables
tables = tbl_stack(
  list(tbl_1, tbl_2, tbl_3, tbl_4, tbl_6, tbl_7, tbl_8, tbl_9, tbl_10, tbl_11, tbl_12),
  group_header = c(
    "Características socioeconómicas del pariente",
    "Antecedentes de la primera infancia y actuales",
    "Antecedentes familiares",
    "Salud mental, nutrición y actividad física",
    "Alergias, asma y rinitis",
    "ISAAC",
    "Biomarcadores",
    "Antropometría",
    "Índices",
    "Porcentaje de grasa corporal",
    "Espirometría"),
  quiet = TRUE
  )

# # Convert gtsummary object to a flextable object and format character columns
# flex_tables <- tables |>
#   gtsummary::as_flex_table() |>
#   flextable::fontsize(part = "all", size = 10) |>
#   ftExtra::colformat_md()
# 
# View (gtsummary object)
tables
```

## Tablas manuscrito

```{r}
# Wilcoxon Effect Size
# my_ES_test <- function(data, variable, by, ...) {
#   rstatix::wilcox_effsize(data, as.formula(glue::glue("{variable} ~ {by}")))$effsize
# }

# Cohen's d
# my_ES_test <- function(data, variable, by, ...) {
#   rstatix::cohens_d(data, as.formula(glue::glue("{variable} ~ {by}")))$effsize
# }

# Cramer's V
# my_cramer_v <- function(data, variable, by, ...) {
#   table(data[[variable]], data[[by]]) |>
#     rstatix::cramer_v()
# }

# Kruskal-Wallis Effect Size (Eta cuadrado)
my_ES_kruskal <- function(data, variable, by, ...) {
  res <- rstatix::kruskal_effsize(data, as.formula(glue::glue("{variable} ~ {by}")))
  paste0(sprintf("%.3f", res$effsize), " ‡")
}

# Cramer's V
my_cramer_v <- function(data, variable, by, ...) {
  v <- rstatix::cramer_v(table(data[[variable]], data[[by]]))
  paste0(sprintf("%.3f", v), " †")
}

# my_ES_test(data_clear, "glucosa", "colegio_id")
# my_cramer_v(data_clear, "metabolic_health", "colegio_id")
```

### Table 1

```{r}
tabla_1 <- data_clear |>
  dplyr::select(
    sexo_factor, edad_anios, peso_kg, talla_m, zbfa_dx, grasa_ip, bp_category, 
    TG_HDL_dx, riesgo_aterogenico, sindrome_metabolico, metabolic_health
  ) |>
  tbl_summary(
    label = list(
      sexo_factor	~ "Sexo",
      edad_anios ~ "Edad (años)",
      peso_kg ~ "Peso (Kg)",
      talla_m	~ "Talla (metros)",
      zbfa_dx ~ "IMC para la edad (OMS)",
      grasa_ip ~ "Grasa corporal (%)",
      bp_category ~ "Riesgo cardiovascular",
      sindrome_metabolico ~ "Síndrome metabólico (IDF)",
      metabolic_health ~ "Fenotipo metabólico (WGOC)",
      TG_HDL_dx	~ "Perfil lipídico",
      riesgo_aterogenico ~ "Dislipidemia aterogénica"
    ),
    missing = "no",
    type = list(edad_anios = "continuous"),
    digits = list(
      all_continuous() ~ c(2, 2), 
      all_categorical() ~ c(1, 1)),
    statistic = list(
      all_categorical() ~ "{n} ({p}%)",
      all_continuous() ~ "{median} ({p25}, {p75})")
  ) |>
  modify_caption("Tabla 1. Características basales de los escolares evaluados.") |>
  modify_abbreviation(
    "IMC: Índice de Masa Corporal; OMS: Organización Mundial de la Salud; IDF: International Diabetes Federation; WGOC: Working Group on Obesity in China") |>
  as_flex_table() |>
  theme_booktabs() |>
  fontsize(size = 9, part = "all") |>
  padding(
    padding.top = 0, padding.bottom = 0, padding.left = 2, padding.right = 2, part = "all") |>
  width(j = 1, width = 1.8) |>
  width(j = 2, width = 1.2) |>
  set_table_properties(layout = "fixed")
```

```{r}
# Definir las propiedades de la sección (Horizontal)
sect_properties <- prop_section(
  page_size = page_size(orient = "portrait"),
  page_margins = page_mar(bottom = 0.5, top = 0.5, right = 0.5, left = 0.5),
  type = "continuous"
)

save_as_docx(
  tabla_1,
  align = "center",
  path = here("outputs", "Table_1.docx"),
  pr_section = sect_properties)
```

### Table 2

Con solo 79 observaciones repartidas en 12 celdas (3x4), el promedio es de apenas 6.5 observaciones por celda. Es casi seguro que algunas celdas tendrán frecuencias esperadas menores a 5. El test de Fisher en tablas mayores a 2x2 es computacionalmente muy exigente. Con una tabla de 3x4, R podría tardar un poco o incluso dar un error si las combinaciones son demasiadas. Para una tabla de estas dimensiones y ese N, lo más riguroso es usar el Test de Fisher con simulación de Monte Carlo. Esto te da la precisión de Fisher sin colapsar la memoria de tu computadora.

```{r}
tabla_2 <- data_clear |>
  dplyr::select(
    sexo_factor, edad_anios, peso_kg, talla_m, zbfa_dx, zhfa_dx, grasa_ip,
    colegio_id) |>
  tbl_summary(
    by = colegio_id,
    percent = "row",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})", 
      all_categorical() ~ "{n} ({p}%)"),
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical() ~ c(1, 1)),
    label = list(
      sexo_factor	~ "Sexo",
      edad_anios ~ "Edad (años)",
      peso_kg ~ "Peso (Kg)",
      talla_m	~ "Talla (metros)",
      zbfa_dx ~ "IMC para la edad (OMS)",
      zhfa_dx ~ "Altura para la edad (OMS)",
      grasa_ip ~ "Grasa corporal (%)"
      ), 
    missing = "no",
    type = list(edad_anios = "continuous")
  ) |>
  add_p(
    test = list(
      all_continuous() ~ "kruskal.test",
      all_categorical() ~ "fisher.test"
    ),
    test.args = list(
      all_categorical() ~ list(simulate.p.value = TRUE, B = 2000)),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  ) |>
  add_stat(
    fns = list(
      all_continuous() ~ my_ES_kruskal,
      all_categorical() ~ my_cramer_v
    )
  ) |>
  modify_header(add_stat_1 ~ "**Effect Size**") |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_fmt_fun(
    p.value ~ function(x) ifelse(is.na(x), "", paste0(style_pvalue(x, digits = 3), "*")),
    rows = var_type == "continuous"
  ) |>
  modify_fmt_fun( 
    p.value ~ function(x) ifelse(is.na(x), "", paste0(style_pvalue(x, digits = 3), "**")),
    rows = var_type %in% c("categorical", "dichotomous")
  ) |>
  modify_header(
    label = "**Características**", 
    stat_1 = "**Jorge Basadre - VMT** (n = {n})",
    stat_2 = "**Santísima Virgen de Chapi - Pachacamac** (n = {n})",
    stat_3 = "**Jesus y María - La Molina** (n = {n})",
    p.value = "Valor p",
    add_stat_1 = "Tamaño del efecto") |>
  modify_caption("Tabla 1. Características sociodemográficas y estado nutricional según institución educativa.") |>
  modify_abbreviation(
    "IMC: Índice de Masa Corporal; OMS: Organización Mundial de la Salud") |>
  modify_footnote(
    starts_with("p.value") ~ 
    "Prueba de Kruskal-Wallis (*); Prueba exacta de Fisher con simulación de Montecarlo (**)",
    add_stat_1 ~ "V de Cramer (†); Magnitud del efecto Eta-cuadrado (‡)"
  ) |>
  as_flex_table() |>
  theme_booktabs() |>
  align(align = "center", part = "header") |>
  align(j = 1, align = "left", part = "header") |>
  align(j = 2:6, align = "center", part = "body") |>
  fontsize(size = 9, part = "all") |>
  padding(padding.top = 0.5, padding.bottom = 0.5, part = "all") |>
  set_table_properties(layout = "autofit", width = 1)
```

```{r}
save_as_docx(
  tabla_2,
  align = "center",
  path = here("outputs", "Table_2.docx"),
  pr_section = sect_properties)
```

### Table 3

```{r}
tabla_3 <- data_clear |>
  dplyr::select(
    # Perfil Metabólico
    metabolic_health, sindrome_metabolico, VAI, VAI_sindrome_metabolico,
    
    # Hemodinámica
    PAS, PAD, bp_category, pulso, indice_cintura_cadera, WHR_cardio, TG_HDL_ratio, 
    riesgo_aterogenico,
    
    # Bioquímica
    glucosa, colesterol_total, trigliceridos, hdl_colesterol, TG_HDL_dx,
    
    # Índices
    TyG, TyG_IR, indice_cintura_talla,
    
    colegio_id
  ) |>
  tbl_summary(
    by = colegio_id,
    percent = "row",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})", 
      all_categorical() ~ "{n} ({p}%)"),
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical() ~ c(1, 1)),
    label = list(
      glucosa ~ "Glucosa plasmática en ayunas (mg/dL)",
      trigliceridos ~ "Triglicéridos (mg/dL)",
      hdl_colesterol ~ "HDL-c (mg/dL)",
      colesterol_total ~ "Colesterol total (mg/dL)",
      PAS ~ "Presión arterial sistólica (mmHg)",
      PAD ~ "Presión arterial diastólica (mmHg)",
      pulso ~ "Pulso cardíaco (latidos por minuto)",
      bp_category ~ "Riesgo cardiovascular",
      TyG ~ "TyG",
      VAI ~ " VAI",
      VAI_sindrome_metabolico ~ "Síndrome metabólico (VAI)",
      sindrome_metabolico ~ "Síndrome metabólico (IDF)",
      metabolic_health ~ "Fenotipo metabólico (WGOC)",
      TyG_IR ~ "Insulinorresistencia (TyG)",
      TG_HDL_dx	~ "Perfil lipídico",
      TG_HDL_ratio ~ "Índice Triglicéridos/HDL-c",
      indice_cintura_cadera ~ "ICC",
      WHR_cardio ~ "Riesgo cardiovascular (ICC)",
      riesgo_aterogenico ~ "Dislipidemia aterogénica",
      indice_cintura_talla ~ "Índice cintura-talla"
    ), 
    missing = "no",
  ) |>
  add_p(
    test = list(
      all_continuous() ~ "kruskal.test",
      all_categorical() ~ "fisher.test"
    ),
    test.args = list(
      all_categorical() ~ list(simulate.p.value = TRUE, B = 2000)),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  ) |>
  add_stat(
    fns = list(
      all_continuous() ~ my_ES_kruskal,
      all_categorical() ~ my_cramer_v
    )
  ) |>
  modify_header(add_stat_1 ~ "**Effect Size**") |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_fmt_fun(
    p.value ~ function(x) ifelse(is.na(x), "", paste0(style_pvalue(x, digits = 3), "*")),
    rows = var_type == "continuous"
  ) |>
  modify_fmt_fun( 
    p.value ~ function(x) ifelse(is.na(x), "", paste0(style_pvalue(x, digits = 3), "**")),
    rows = var_type %in% c("categorical", "dichotomous")
  ) |>
  modify_header(
    label = "**Características**", 
    stat_1 = "**Jorge Basadre - VMT** (n = {n})",
    stat_2 = "**Santísima Virgen de Chapi - Pachacamac** (n = {n})",
    stat_3 = "**Jesus y María - La Molina** (n = {n})",
    p.value = "Valor p",
    add_stat_1 = "Tamaño del efecto") |>
  modify_caption("Tabla 1. Comparación de indicadores de salud cardiometabólico entre las instituciones educativas.") |>
  modify_abbreviation(
    "HDL-c: High density lipoprotein; TyG: Índice triglicéridos-glucosa; VAI: Índice de adiposidad visceral; IDF: International Diabetes Federation; WGOC: Working Group on Obesity in China; ICC: Índice Cintura-Cadera") |>
  modify_footnote(
    starts_with("p.value") ~ 
    "Prueba de Kruskal-Wallis (*); Prueba exacta de Fisher con simulación de Montecarlo (**)",
    add_stat_1 ~ "V de Cramer (†); Magnitud del efecto Eta-cuadrado (‡)"
  ) |>
  as_flex_table() |>
  theme_booktabs() |>
  align(align = "center", part = "header") |>
  align(j = 1, align = "left", part = "header") |>
  align(j = 2:6, align = "center", part = "body") |>
  fontsize(size = 9, part = "all") |>
  padding(padding.top = 0.5, padding.bottom = 0.5, part = "all") |>
  set_table_properties(layout = "autofit", width = 1)
```

```{r}
save_as_docx(
  tabla_3,
  align = "center",
  path = here("outputs", "Table_3.docx"),
  pr_section = sect_properties)
```

### Table 4

```{r}
tabla_4 <- data_clear |>
  dplyr::select(PHQ_9, depresion, GAD_7, ansiedad, afhc_score, dinamometria,
    categoria_afhc, paqc_final_score, paqc_dx, colegio_id) |>
  tbl_summary(
    by = colegio_id,
    percent = "row",
    statistic = list(
      all_continuous() ~ "{median} ({p25}, {p75})", 
      all_categorical() ~ "{n} ({p}%)"),
    digits = list(
      all_continuous() ~ c(2, 2),
      all_categorical() ~ c(1, 1)),
    label = list(
      PHQ_9 ~ "Puntaje del PHQ-9",
      depresion ~ "Gravedad de la depresión",
      GAD_7 ~ "Puntaje del GAD-7",
      ansiedad ~ "Trastorno de ansiedad generalizada",
      afhc_score ~ "Puntaje del AFHS",
      categoria_afhc ~ "Hábitos alimentarios para adolescentes",
      paqc_final_score ~ "Puntaje del PAQ-A",
      paqc_dx ~ "Actividad física del adolescentes",
      dinamometria ~ "Dinapenia"
    ),
    missing = "no"
  ) |>
  add_p(
    test = list(
      all_continuous() ~ "kruskal.test",
      all_categorical() ~ "fisher.test"
    ),
    test.args = list(
      all_categorical() ~ list(simulate.p.value = TRUE, B = 2000)),
    pvalue_fun = ~ style_pvalue(.x, digits = 3)
  ) |>
  add_stat(
    fns = list(
      all_continuous() ~ my_ES_kruskal,
      all_categorical() ~ my_cramer_v
    )
  ) |>
  modify_header(add_stat_1 ~ "**Effect Size**") |>
  bold_labels() |>
  bold_p(t = 0.05) |>
  modify_fmt_fun(
    p.value ~ function(x) ifelse(is.na(x), "", paste0(style_pvalue(x, digits = 3), "*")),
    rows = var_type == "continuous"
  ) |>
  modify_fmt_fun( 
    p.value ~ function(x) ifelse(is.na(x), "", paste0(style_pvalue(x, digits = 3), "**")),
    rows = var_type %in% c("categorical", "dichotomous")
  ) |>
  modify_header(
    label = "**Características**", 
    stat_1 = "**Jorge Basadre - VMT** (n = {n})",
    stat_2 = "**Santísima Virgen de Chapi - Pachacamac** (n = {n})",
    stat_3 = "**Jesus y María - La Molina** (n = {n})",
    p.value = "Valor p",
    add_stat_1 = "Tamaño del efecto") |>
  modify_caption("Tabla 2. Comparación de indicadores de salud mental y estilos de vida saludable entre las instituciones educativas.") |>
  modify_abbreviation(
    "PHQ-9: Patient Health Questionnaire-9; GAD-7: Generalized Anxiety Disorder-7; AFHC: Adolescent Food Habits Checklist; PAQ-A: Physical Activity Questionnaire for Adolescents") |>
  modify_footnote(
    starts_with("p.value") ~ 
    "Prueba de Kruskal-Wallis (*); Prueba exacta de Fisher con simulación de Montecarlo (**)",
    add_stat_1 ~ "V de Cramer (†); Magnitud del efecto Eta-cuadrado (‡)"
  ) |>
  as_flex_table() |>
  theme_booktabs() |>
  align(align = "center", part = "header") |>
  align(j = 1, align = "left", part = "header") |>
  align(j = 2:6, align = "center", part = "body") |>
  fontsize(size = 9, part = "all") |>
  padding(padding.top = 0.5, padding.bottom = 0.5, part = "all") |>
  set_table_properties(layout = "autofit", width = 1)
```

```{r}
save_as_docx(
  tabla_4,
  align = "center",
  path = here("outputs", "Table_4.docx"),
  pr_section = sect_properties)
```

Para que tu reporte sea impecable, recuerda que el tamaño del efecto se suele interpretar así:

-   Eta-cuadrado ($\eta^2$): \~0.01 (pequeño), \~0.06 (moderado), \>0.14 (grande). V de Cramer (3x4): Al ser una tabla de este tamaño, un valor \>0.15 suele considerarse un efecto moderado y \>0.25 un efecto fuerte.

-   Calculo del tamaño de muestra basada en conglomerados, para que la unidad de analisis sean colegios y no niños


# Tamaño de muestra

```{r}
#| eval: false
m <- 35           # Niños que tienes por colegio (limitado)
efecto <- 0.33    # Efecto esperado del PM2.5 (pequeño)
alfa <- 0.05      # Nivel de significancia [cite: 103]
poder <- 0.80     # Poder deseado [cite: 103]
icc <- 0.02       # Interdependencia estimada dentro del colegio [cite: 165]

# 1. Calcular N individual (como si no hubiera colegios) [cite: 77, 81]
calc_n <- pwr.t.test(d = efecto, sig.level = alfa, power = poder, type = "two.sample")
n_indiv_total <- ceiling(calc_n$n * 2) # Total para ambos grupos (expuestos vs control)

# 2. Calcular el Efecto de Diseño (DE) 
de <- 1 + icc * (m - 1)

# 3. Calcular el número total de niños necesarios ajustados [cite: 112]
n_ajustado <- n_indiv_total * de

# 4. Calcular el número de colegios (k) necesarios
k_total <- ceiling(n_ajustado / m)

# --- RESULTADOS ---
cat("Niños necesarios si fueran independientes:", n_indiv_total, "\n")
cat("Efecto de Diseño (DE):", de, "\n")
cat("Número total de colegios (k) necesarios:", k_total, "\n")
cat("Total de niños a reclutar:", k_total * m, "\n")
```

```{r}
#| eval: false
# Parámetros de la cohorte
n_indiv <- 350       # Niños necesarios para detectar el efecto (Paso 1) [cite: 85]
m <- 25              # Niños disponibles por colegio actualmente
años_estudio <- 1    # Duración del seguimiento
tasa_atricion <- 0.10 # 10% de pérdida anual esperada
icc <- 0.02          # Correlación por colegio [cite: 103]

# 1. Ajuste por atrición (Paso adicional para cohorte)
# Necesitas reclutar más niños hoy porque algunos se irán
n_reclutar_indiv <- n_indiv / (1 - tasa_atricion)^años_estudio

# 2. Cálculo del Efecto de Diseño (DE) de Sadler et al.
de <- 1 + icc * (m - 1) # [cite: 150]

# 3. Cálculo de colegios (k) necesarios
k_necesarios <- (n_reclutar_indiv * de) / m

# Resultados
cat("Niños a reclutar inicialmente (ajustado por pérdida):", ceiling(n_reclutar_indiv), "\n")
cat("Efecto de Diseño:", de, "\n")
cat("Número de colegios necesarios (k):", ceiling(k_necesarios), "\n")
```

```{r}
#| eval: false
# --- PARÁMETROS DE LA COHORTE ---
p1 <- 0.32          # Incidencia en grupo control (10%)
p2 <- 0.33          # Incidencia en grupo expuesto (18%)
m <- 25             # Niños que puedes conseguir por colegio (limitado)
icc <- 0.02         # Valor usado por Sadler et al. para cálculos de poder [cite: 147]
atricion <- 0.10    # 15% de pérdida de seguimiento esperada
alfa <- 0.05        # Significancia [cite: 85]
poder <- 0.80       # Poder estadístico [cite: 85]

# 1. Tamaño de muestra individual (Efecto de Tamaño para Proporciones)
# Calculamos la 'h' de Cohen para proporciones
h_size <- pwr::ES.h(p1, p2) 
n_srs <- pwr.2p.test(h = h_size, sig.level = alfa, power = poder)$n * 2

# 2. Cálculo del Efecto de Diseño (DE) según Sadler et al.
de <- 1 + icc * (m - 1)

# 3. Tamaño de muestra total ajustado por clusters y atrición
n_final <- (n_srs * de) / (1 - atricion)

# 4. Número de colegios (k) necesarios
k_total <- ceiling(n_final / m)

# --- RESULTADOS ---
cat("Niños necesarios (independientes):", ceiling(n_srs), "\n")
cat("Efecto de Diseño (DE):", de, "\n")
cat("Número total de colegios necesarios:", k_total, "\n")
cat("Total de niños a reclutar:", k_total * m, "\n")
```

```{r}
#| eval: false
# ---- Tamaño de muestra CRT continuo con ajuste por baseline (sin paquetes) ----
alpha <- 0.05
power <- 0.80

sigma <- 8.73     # SD SBP (Liang)
r     <- 0.60     # corr baseline-followup
ICC   <- 0.02
m     <- 32       # niños por colegio (follow-up completo)
Delta <- 2.21     # mmHg (Liang)

z_alpha <- qnorm(1 - alpha/2)
z_beta  <- qnorm(power)

vart_adj <- sigma^2 * (1 - r^2)           # ajuste por baseline
DE <- 1 + (m - 1) * ICC                   # design effect

k_per_arm <- ((z_alpha + z_beta)^2 * 2 * vart_adj * DE) / (m * Delta^2)
K_total   <- ceiling(2 * k_per_arm)

k_per_arm
K_total

loss <- 0.10  # 10%
m_recruit <- ceiling(m / (1 - loss))
N_recruit <- K_total * m_recruit

m_recruit
N_recruit
```
